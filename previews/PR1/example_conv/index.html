<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Example, conventional lyo · LyoPronto.jl</title><meta name="title" content="Example, conventional lyo · LyoPronto.jl"/><meta property="og:title" content="Example, conventional lyo · LyoPronto.jl"/><meta property="twitter:title" content="Example, conventional lyo · LyoPronto.jl"/><meta name="description" content="Documentation for LyoPronto.jl."/><meta property="og:description" content="Documentation for LyoPronto.jl."/><meta property="twitter:description" content="Documentation for LyoPronto.jl."/><script data-outdated-warner src="../assets/warner.js"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.050/juliamono.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.8/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL=".."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../assets/documenter.js"></script><script src="../search_index.js"></script><script src="../siteinfo.js"></script><script src="../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/catppuccin-mocha.css" data-theme-name="catppuccin-mocha"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/catppuccin-macchiato.css" data-theme-name="catppuccin-macchiato"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/catppuccin-frappe.css" data-theme-name="catppuccin-frappe"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/catppuccin-latte.css" data-theme-name="catppuccin-latte"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../assets/themeswap.js"></script></head><body><div id="documenter"><nav class="docs-sidebar"><div class="docs-package-name"><span class="docs-autofit"><a href="../">LyoPronto.jl</a></span></div><button class="docs-search-query input is-rounded is-small is-clickable my-2 mx-auto py-1 px-2" id="documenter-search-query">Search docs (Ctrl + /)</button><ul class="docs-menu"><li><a class="tocitem" href="../">Home</a></li><li class="is-active"><a class="tocitem" href>Example, conventional lyo</a><ul class="internal"><li><a class="tocitem" href="#Setup"><span>Setup</span></a></li><li><a class="tocitem" href="#Packages-Used"><span>Packages Used</span></a></li><li><a class="tocitem" href="#Loading-Experimental-Data"><span>Loading Experimental Data</span></a></li><li><a class="tocitem" href="#Set-up-model-parameters"><span>Set up model parameters</span></a></li><li><a class="tocitem" href="#Run-a-sanity-check-simulation"><span>Run a sanity-check simulation</span></a></li><li><a class="tocitem" href="#Minimize-least-square-difference-to-compare-to-experimental-data"><span>Minimize least square difference to compare to experimental data</span></a></li><li><a class="tocitem" href="#Going-further"><span>Going further</span></a></li></ul></li><li><a class="tocitem" href="../alldocstrings/">Reference</a></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><a class="docs-sidebar-button docs-navbar-link fa-solid fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a><nav class="breadcrumb"><ul class="is-hidden-mobile"><li class="is-active"><a href>Example, conventional lyo</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Example, conventional lyo</a></li></ul></nav><div class="docs-right"><a class="docs-navbar-link" href="https://github.com/LyoHUB/LyoPronto.jl" title="View the repository on GitHub"><span class="docs-icon fa-brands"></span><span class="docs-label is-hidden-touch">GitHub</span></a><a class="docs-navbar-link" href="https://github.com/LyoHUB/LyoPronto.jl/blob/main/docs/src/example_conv.md" title="Edit source on GitHub"><span class="docs-icon fa-solid"></span></a><a class="docs-settings-button docs-navbar-link fa-solid fa-gear" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-article-toggle-button fa-solid fa-chevron-up" id="documenter-article-toggle-button" href="javascript:;" title="Collapse all docstrings"></a></div></header><article class="content" id="documenter-page"><h1 id="Example:-Tuning-Mass-Transfer-Resistance"><a class="docs-heading-anchor" href="#Example:-Tuning-Mass-Transfer-Resistance">Example: Tuning Mass Transfer Resistance</a><a id="Example:-Tuning-Mass-Transfer-Resistance-1"></a><a class="docs-heading-anchor-permalink" href="#Example:-Tuning-Mass-Transfer-Resistance" title="Permalink"></a></h1><p>The source code for this example can be found in <code>LyoPronto.jl/scripts/tuning_sucrose_Rp.jl</code>. </p><h2 id="Setup"><a class="docs-heading-anchor" href="#Setup">Setup</a><a id="Setup-1"></a><a class="docs-heading-anchor-permalink" href="#Setup" title="Permalink"></a></h2><p>My current recommended approach for making use of this package is to have installed <code>LyoPronto</code> as a dependency of your project, according to the <a href="../#Installation">install instructions</a></p><p>For management of your project, <a href="https://juliadynamics.github.io/DrWatson.jl/stable/">DrWatson.jl</a> is an effective tool which I like. I will demonstrate some usage of that tool here.</p><h2 id="Packages-Used"><a class="docs-heading-anchor" href="#Packages-Used">Packages Used</a><a id="Packages-Used-1"></a><a class="docs-heading-anchor-permalink" href="#Packages-Used" title="Permalink"></a></h2><p>First, we will load packages.</p><pre><code class="language-julia hljs">using LyoPronto</code></pre><p><code>LyoPronto</code> reexports the following packages from <code>OrdinaryDiffEqRosenbrock</code>, <code>OrdinaryDiffEqNonlinearSolve</code>, <code>DiffEqCallbacks</code>, and <code>Unitful</code>, so those are available after <code>using LyoPronto</code>.</p><p>The following packages are not exported by LyoPronto, so you will have to install them and import them as well to follow along here.</p><pre><code class="nohighlight hljs">using DrWatson
using CSV
using TypedTables
using LaTeXStrings
using SavitzkyGolay
using Optim
using Plots
using StatsPlots: @df
using Accessors</code></pre><p>The following packages are used in this example:</p><h2 id="Loading-Experimental-Data"><a class="docs-heading-anchor" href="#Loading-Experimental-Data">Loading Experimental Data</a><a id="Loading-Experimental-Data-1"></a><a class="docs-heading-anchor-permalink" href="#Loading-Experimental-Data" title="Permalink"></a></h2><p>First, load a <code>.csv</code> of experimental data with <code>CSV</code> and <code>TypedTables</code>. <code>CSV.read</code> method, and use <code>DrWatson</code>&#39;s <code>datadir</code> function to help keep directory structure clean.</p><p>This file has 7 rows of metadata at the top, so the data headers are at row 8; it is located in the project directory under <code>[project]/data/exp_raw/&quot;2024-06-21-16_MFD_AH.csv</code>.</p><pre><code class="language-julia hljs">data_raw = CSV.read(datadir(&quot;exp_raw&quot;, &quot;2024-06-21-16_MFD_AH.csv&quot;), Table, header=8)</code></pre><p>We can use the tools from <code>TypedTables</code> to make the native column names from the Millrock MicroFD lyophilizer a little more Julia-friendly, with a function like the following.  This function does the double duty of also attaching Unitful units to these columns. (This function can be put into your own package if you will use it often.)  </p><pre><code class="language-julia hljs">function microfd_columnrename(row)
    # nt = (tstamp = DateTime(row.Timestamp, dateformat&quot;mm/dd/yyyy H:M:S&quot;),
    nt = (tstamp = row.CycleTime,
          phase = row.Phase,
          step = row.Step,
          pch_sp = row.VacSetPT*u&quot;mTorr&quot;,
          pch_pir = row.VacPirani*u&quot;mTorr&quot;,
          pch_cm = row.VacCPM*u&quot;mTorr&quot;,
          Tsh_sp = row.ShelfSetPT*u&quot;°C&quot;,
          Tsh_i = row.ShelfInlet*u&quot;°C&quot;,
          T1 = row.TP1*u&quot;°C&quot;,
          T2 = row.TP2*u&quot;°C&quot;,
          T3 = row.TP4*u&quot;°C&quot;, # Not a mistake: quirk of experimental apparatus that connection TP3 was more annoying than TP4
          # if a column has names with whitespace 
          # or special characters in it, do this:
          # mfr = row.var&quot;Mass Flow Rate&quot;
    )
    return nt
end</code></pre><p>Apply this function as <a href="https://typedtables.juliadata.org/stable/man/tutorial/#Mapping-data">shown in the TypedTables tutorial</a>, then we will add a column where time counts from 0 rather than being the time it was gathered. (We also need to account for how this cycle ran over several nights and so timesteps go to 0.)</p><pre><code class="language-julia hljs">procdata_pre = map(microfd_columnrename, data_raw)
t = procdata_pre.tstamp .- procdata_pre.tstamp[1] .|&gt; u&quot;hr&quot;
for _ in 1:7 # Check up to 7 days
    # If the time isn&#39;t monotonically increasing... 
    all(t[2:end] .- t[1:end-1] .&gt; 0u&quot;hr&quot;) &amp;&amp; break
    # find the first place where it drops,
    first_i = findfirst(t[2:end] .- t[1:end-1] .&lt; 0u&quot;hr&quot;) + 1
    # and add 24 hours to the rest of the points
    t[first_i:end] .+= 24u&quot;hr&quot;
end
procdata = Table(procdata_pre; t=t)</code></pre><p>To make sure you did this right, a good sanity check is to <code>plot(t)</code> and see that it is monotonically increasing.</p><p>For the Millrock MicroFD lyophilizer that data was gathered on, the file has a column <code>Phase</code> indicating what step of the process is going on, so to select out the primary drying data out we can filter by rows where <code>phase == 4</code>:</p><pre><code class="language-julia hljs">pd_data = filter(x-&gt;x.phase == 4, procdata)
pd_data.t .-= pd_data.t[1]</code></pre><p>To check that everything looks right, plot the temperatures, taking advantage of a recipe from this package, as well as the <code>L&quot;[latex]&quot;</code> macro from <code>LaTeXStrings</code>. We can also exploit the <code>@df</code> macro from <code>StatsPlots</code> to make this really smooth.</p><pre><code class="language-julia hljs">@df pd_data exptfplot(:t, :T1, :T2, :T3, labels=[L&quot;T_{p1}&quot; L&quot;T_{p2}&quot; L&quot;T_{p3}&quot;])
@df pd_data plot!(:t, :Tsh_sp, c=:black, label=L&quot;T_{sh}&quot;)</code></pre><p>Look at the Pirani pressure and ascertain the end of drying by using a Savitzky-Golay filter to identify a maximum in the second derivative. Note that because <code>SavitzkyGolay</code> doesn&#39;t play nice with Unitful, we strip out units and add them back in. Another plot recipe plots the end of drying as a vertical line on that pressure graph.</p><pre><code class="language-julia hljs">p_pir_sm = savitzky_golay(ustrip.(u&quot;mTorr&quot;, pd_data.pch_pir), 91, 3, deriv=0).y *u&quot;mTorr&quot; # 91 a window width; 3 the polynomial order
p_pir_der2 = savitzky_golay(ustrip.(u&quot;mTorr&quot;, pd_data.pch_pir), 91, 3, deriv=2).y
t_end = pd_data.t[argmax(p_pir_der2[100:end])+99] # Skip past the beginning, where pressure might be weird
@df pd_data plot(:t, :pch_pir, label=&quot;data&quot;)
@df pd_data plot!(:t, p_pir_sm, label=&quot;smoothed data&quot;)
tendplot!(t_end, label=L&quot;t_{end}&quot;)</code></pre><p>Based on an examination of the temperature data, we want to go only up to the &quot;temperature rise&quot; commonly observed in lyophilization near (but not at) the end of drying. This happens at 7.5 hours for <code>T1</code> and <code>T3</code> and at about 12.5 hours for <code>T2</code>. To pass this information on to the least-squares fitting routine, one could manually trim down all the data to compare, which I have done many times. But since this is such a common operation, I made <a href="../alldocstrings/#LyoPronto.PrimaryDryFit">a tool</a> which encodes this information:</p><pre><code class="language-julia hljs">fitdat_all = PrimaryDryFit(pd_data.t, 
                        (pd_data.T1[pd_data.t .&lt; 7.5u&quot;hr&quot;],
                        pd_data.T2[pd_data.t .&lt; 12u&quot;hr&quot;],
                        pd_data.T3[pd_data.t .&lt; 7.5u&quot;hr&quot;]),
                        t_end)</code></pre><p>Note that by passing all three temperature series to <code>PrimaryDryFit</code>, this will compare model output to all three temperature series. But in this case, <span>$T_1$</span> might be an edge vial we want to fit separately, so let&#39;s actually use</p><pre><code class="language-julia hljs">fitdat_center = PrimaryDryFit(pd_data.t, 
                        (pd_data.T2[pd_data.t .&lt; 12u&quot;hr&quot;],
                        pd_data.T3[pd_data.t .&lt; 7.5u&quot;hr&quot;]),
                        t_end)
fitdat_edge = PrimaryDryFit(pd_data.t, pd_data.T1[pd_data.t .&lt; 7.5u&quot;hr&quot;])</code></pre><p>There&#39;s also a plot recipe for this type–call <code>plot(fitdat_center)</code> and you can get an immediate feel if you got the right data or not.</p><h2 id="Set-up-model-parameters"><a class="docs-heading-anchor" href="#Set-up-model-parameters">Set up model parameters</a><a id="Set-up-model-parameters-1"></a><a class="docs-heading-anchor-permalink" href="#Set-up-model-parameters" title="Permalink"></a></h2><p>Below, we make liberal use of Unitful units. Also note that <a href="../alldocstrings/#LyoPronto.RampedVariable"><code>RampedVariable</code></a> and <a href="../alldocstrings/#LyoPronto.RpFormFit"><code>RpFormFit</code></a> are used to simplify some common things we use.</p><pre><code class="language-julia hljs"># Vial geometry
vialsize = &quot;6R&quot;
Ap, Av = π.*get_vial_radii(vialsize).^2

# Formulation parameters; Rp here is a placeholder guess
c_solid = 0.05u&quot;g/mL&quot; # g solute / mL solution
ρ_solution = 1u&quot;g/mL&quot; # g/mL total solution density
R0 = 0.8u&quot;cm^2*Torr*hr/g&quot;
A1 = 14u&quot;cm*Torr*hr/g&quot;
A2 = 1u&quot;1/cm&quot;
Rp = RpFormFit(R0, A1, A2)

# Fill
Vfill = 3u&quot;mL&quot; # ml
hf0 = Vfill / Ap

# Cycle parameters
pch = RampedVariable(70u&quot;mTorr&quot;) # constant pressure
T_shelf_0 = -40.0u&quot;°C&quot; # initial shelf temperature
T_shelf_final = -10.0u&quot;°C&quot;  # final shelf temperature
ramp_rate = 0.5 *u&quot;K/minute&quot; # ramp rate
# Ramp for shelf temperature: convert to Kelvin because Celsius doesn&#39;t do math very well
Tsh = RampedVariable(uconvert.(u&quot;K&quot;, [T_shelf_0, T_shelf_final]), ramp_rate)

# Guess for heat transfer
KC = 6.556e-5u&quot;cal/s/K/cm^2&quot;
KP = 2.41e-3u&quot;cal/s/K/cm^2/Torr&quot;
KD = 2.62u&quot;1/Torr&quot;
Kshf = RpFormFit(KC, KP, KD)
# Alternative guess, without pressure dependence:
# Kshf = p-&gt; 5.0u&quot;W/m^2/K&quot;

params_bunch = [
    (Rp, hf0, c_solid, ρ_solution),
    (Kshf, Av, Ap),
    (pch, Tsh)
]

paramobj = ParamObjPikal(params_bunch)
</code></pre><h2 id="Run-a-sanity-check-simulation"><a class="docs-heading-anchor" href="#Run-a-sanity-check-simulation">Run a sanity-check simulation</a><a id="Run-a-sanity-check-simulation-1"></a><a class="docs-heading-anchor-permalink" href="#Run-a-sanity-check-simulation" title="Permalink"></a></h2><pre><code class="language-julia hljs"># Time span: used to set initial time and to give an upper bound on time, in case parameters are bad
tspan = (0.0, 100.0) # hours
# Initial condition
u0 = ustrip.([u&quot;cm&quot;, u&quot;K&quot;], [hf0, Tsh(0u&quot;minute&quot;)])

# Set up as an ODE problem
prob = ODEProblem(lyo_1d_dae_f, u0, tspan, paramobj)
# Solve with the Rodas4P() algorithm, use a callback provided by LyoPronto to terminate at end of drying
sol = solve(prob, Rodas4P(), callback=end_drying_callback)
</code></pre><p>And then plot these results with a recipe, to make sure that the chosen <span>$K_{sh-f}$</span> and <span>$R_p$</span> are physically reasonable guesses (though they will not be exact):</p><pre><code class="language-julia hljs">@df pd_data plot(:t, :Tsh_sp, c=:black, label=L&quot;T_{sh}&quot;)
plot!(fitdat_center)
tendplot!(fitdat_center.t_end, label=L&quot;t_{end}&quot;)
modconvtplot!(sol, label=L&quot;$T_p$, model&quot;)</code></pre><h2 id="Minimize-least-square-difference-to-compare-to-experimental-data"><a class="docs-heading-anchor" href="#Minimize-least-square-difference-to-compare-to-experimental-data">Minimize least square difference to compare to experimental data</a><a id="Minimize-least-square-difference-to-compare-to-experimental-data-1"></a><a class="docs-heading-anchor-permalink" href="#Minimize-least-square-difference-to-compare-to-experimental-data" title="Permalink"></a></h2><p>First, set up a function that takes <span>$K_{sh-f}$</span> and <span>$R_p$</span> and returns a solution object (see <a href="../alldocstrings/#LyoPronto.gen_sol_conv_dim-NTuple{4, Any}"><code>gen_sol_conv_dim</code></a> ).</p><pre><code class="language-julia hljs">gen_sol_conv = KRp -&gt; gen_sol_conv_dim(KRp, paramobj, u0, tspan)</code></pre><p>Next, set up an objective function we will minimize (see <a href="../alldocstrings/#LyoPronto.obj_expT-Tuple{Any, Any}"><code>obj_expT</code></a> for details), but basically: we use <code>gen_sol_conv</code> to generate a solution object, which is the first in a tuple of return values, and compare that solution to <code>fitdat</code> which are the fitting data selected above.</p><pre><code class="language-julia hljs">obj_KRp = KRp -&gt;  obj_expT(gen_sol_conv(KRp)[1], fitdat)</code></pre><p>It&#39;s a good idea at this point to make sure that the objective function is working as expected:</p><pre><code class="language-julia hljs">KRp_guess = [12, 0.1, 5, 0.1]
obj_KRp(KRp_guess)</code></pre><p>should return a number.</p><p>Now, to actually carry out the fitting, we find a minimum for this objective function, using <code>Optim</code> with the <code>NelderMead()</code> algorithm:</p><pre><code class="language-julia hljs">opt_KRp = optimize(obj_KRp, KRp_guess, NelderMead())</code></pre><p>Get out the found values of our tuning parameters, and generate the corresponding solution profile:</p><pre><code class="language-julia hljs">KRp = Optim.minimizer(opt_KRp)
prof, optparams = gen_sol_conv(KRp)</code></pre><p>Plot and compare experiment to model:</p><pre><code class="language-julia hljs">@df pd_data exptfplot(:t, :T1, :T2, :T3, labels=[L&quot;T_{p1}&quot; L&quot;T_{p2}&quot; L&quot;T_{p3}&quot;])
plot!(Tsh, label=L&quot;T_{sh}&quot;)
modconvtplot!(prof)
tendplot!(t_end)
plot!(xlim = (0, 20))</code></pre><h2 id="Going-further"><a class="docs-heading-anchor" href="#Going-further">Going further</a><a id="Going-further-1"></a><a class="docs-heading-anchor-permalink" href="#Going-further" title="Permalink"></a></h2><p>Suppose we want to fit a different <span>$K_v$</span> for the vial I said might be an edge vial, we can write another objective function for that, do new fitting, and add that to the plot.</p><pre><code class="language-julia hljs"># Write a general function that takes K, solves model
function gen_sol_K_edge(K, po::ParamObjPikal, u0, timespan)
    new_params = @set po.Kshf = x-&gt;(K*u&quot;W/m^2/K&quot;)
    prob = ODEProblem(lyo_1d_dae_f, u0, timespan, new_params)
    sol = solve(prob, Rosenbrock23(autodiff=false), callback=end_drying_callback)
    return sol, new_params
end

# Make a specific version for this experiment, with Rp tuned from above
gen_sol_K = K-&gt;gen_sol_K_edge(K, optparams, u0, tspan)

obj_K_edge = Kvec-&gt;obj_expT(gen_sol_K(Kvec[1])[1], fitdat_edge)

opt_K_edge = optimize(obj_K_edge, [10.0], NelderMead())

K_edge = Optim.minimizer(opt_K_edge)[1]

prof_edge = gen_sol_K(K_edge)[1]

@df pd_data exptfplot(:t, :T1, :T2, :T3, labels=[L&quot;T_{p1}&quot; L&quot;T_{p2}&quot; L&quot;T_{p3}&quot;])
plot!(Tsh, label=L&quot;T_{sh}&quot;, color=:black)
modconvtplot!(prof, prof_edge, labels=[L&quot;$T_{p}$, center&quot; L&quot;$T_{p}$, edge&quot;])
tendplot!(t_end, label=L&quot;t_{end}&quot;)
plot!(xlim = (0, 20))</code></pre></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../">« Home</a><a class="docs-footer-nextpage" href="../alldocstrings/">Reference »</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="auto">Automatic (OS)</option><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option><option value="catppuccin-latte">catppuccin-latte</option><option value="catppuccin-frappe">catppuccin-frappe</option><option value="catppuccin-macchiato">catppuccin-macchiato</option><option value="catppuccin-mocha">catppuccin-mocha</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 1.8.0 on <span class="colophon-date" title="Thursday 21 November 2024 11:30">Thursday 21 November 2024</span>. Using Julia version 1.11.1.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
